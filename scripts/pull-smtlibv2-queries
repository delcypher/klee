#!/bin/bash
#By Dan Liew

function usage()
{
	echo "Usage: $0 [options] <input file> <destination directory>"
	echo "This program takes a collection of SMTLIBv2 queries in a KLEE \"queries.smt2\""
	echo "file and splits them into seperate queries. This queries are placed in the user's"
	echo "directory of choice."
	echo ""
	echo "<input file> - a queries.smt2 file generated by KLEE"
	echo "<destination directory> - The location to put the seperated query files"
	echo ""
	echo "Options"
	echo "--strip : Remove (get-value) and (set-option ) commands from queries."
	echo "--help  : Show this message"
}

STRIP_GET_VALUE=0

#Check we have minimum number of arguments
if [ $# -lt 2 ]; then 
	usage
	exit;
fi

#Parse options
while [ -n $1 ] ; do

	if [ $( echo "$1" | grep -Ec '^--') -eq 1 ]; then

		#handle options
		case "$1" in
			--help)
				usage;
				exit 1;
				;;

			--strip)
				STRIP_GET_VALUE=1;
				echo "Stripping (get-value) commands."
				;;

			*)
				echo "Option $1 not recognised."
				exit 1;
				;;
		esac
	else
		break;
	fi

	#grab next argument
	shift
done

#The remaining arguments are the input and directory
if [ $# -ne 2 ]; then
	echo "<input file> and <destination directory> must be specified"
	exit 1;
fi

INPUT="$1"
DEST_DIR="$2"

#Strip trailing slashes from DEST_DIR
DEST_DIR=$( echo "${DEST_DIR}" | sed 's#/\+$##')

#Check DEST_DIR is a directory
if [ ! -d "${DEST_DIR}" ]; then
	echo "\"${DEST_DIR}\" is not a directory!"
	exit 1;
fi

#Check input exists
if [ ! -f "${INPUT}" ]; then
	echo "\"${INPUT}\" cannot be read."
	exit 1;
fi

#Get all the lines that start a query
START_LINES=( $(sed -n '/^;SMTLIBv2/=' ${INPUT} ) )

echo "Found ${#START_LINES[@]} queries"

#Loop over the different queries
for ((q=0; q < ${#START_LINES[@]}; q++))
do
	#Get the beginning line
	BEGIN_LINE=${START_LINES[$q]}

	#Get the end line 
	NEXT_INDEX=$(( q + 1))
	END_LINE=${START_LINES[$NEXT_INDEX]}
	END_LINE=$(( END_LINE -1))

	#If on last query use special last line symbol
	if [ "${END_LINE}" = "-1" ]; then END_LINE='$'; fi

	#Grab query number
	QUERY_NO=$(sed -n "${BEGIN_LINE},${BEGIN_LINE}s/^;SMTLIBv2 Query \([0-9]\+\) .\+/\1/;${BEGIN_LINE},${BEGIN_LINE}p" "${INPUT}")
	echo "query: ${QUERY_NO}"

	#Generate file
	FILENAME="${DEST_DIR}/query.${QUERY_NO}.smt2"
	echo "Generating file ${FILENAME}"

	if [ "${STRIP_GET_VALUE}" -eq 0 ]; then
		#Don't strip some commands
		sed -n "${BEGIN_LINE},${END_LINE}p" "${INPUT}" > "${FILENAME}"
	else

		#Strip some commands
		sed -n "/^(get-value/d;/^(set-option/d;${BEGIN_LINE},${END_LINE}p" "${INPUT}" > "${FILENAME}"
	fi
done

